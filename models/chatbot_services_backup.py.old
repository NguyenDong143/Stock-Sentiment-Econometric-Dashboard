"""
Chatbot Services - Portfolio AI Assistant using Google Gemini API
"""

import google.generativeai as genai
from typing import Optional, List, Dict


class PortfolioChatbot:
    """
    AI Chatbot for portfolio and stock analysis using Google Gemini
    """
    
    def __init__(self, api_key: str):
        """
        Initialize chatbot with Gemini API
        
        Args:
            api_key (str): Google Gemini API key
        """
        genai.configure(api_key=api_key)
        # S·ª≠ d·ª•ng model m·ªõi gemini-1.5-flash thay v√¨ gemini-pro ƒë√£ deprecated
        self.model = genai.GenerativeModel('gemini-1.5-flash')
        self.chat_history = []
        
        # System prompt for portfolio assistant
        self.system_prompt = """B·∫°n l√† m·ªôt tr·ª£ l√Ω AI chuy√™n v·ªÅ ph√¢n t√≠ch c·ªï phi·∫øu v√† tin t·ª©c t√†i ch√≠nh.
        
Nhi·ªám v·ª• c·ªßa b·∫°n:
- Gi·∫£i th√≠ch c√°c ch·ªâ s·ªë t√†i ch√≠nh (sentiment score, correlation, Granger causality, TVAR)
- T∆∞ v·∫•n v·ªÅ ph√¢n t√≠ch c·∫£m x√∫c tin t·ª©c v√† ·∫£nh h∆∞·ªüng ƒë·∫øn gi√° c·ªï phi·∫øu
- Gi·∫£i ƒë√°p c√¢u h·ªèi v·ªÅ m√¥ h√¨nh kinh t·∫ø l∆∞·ª£ng
- Cung c·∫•p th√¥ng tin d·ªÖ hi·ªÉu v√† ch√≠nh x√°c

H√£y tr·∫£ l·ªùi ng·∫Øn g·ªçn, r√µ r√†ng v√† chuy√™n nghi·ªáp b·∫±ng ti·∫øng Vi·ªát."""
    
    def generate_response(self, user_message: str, context: Optional[str] = None) -> str:
        """
        Generate response from user message
        
        Args:
            user_message (str): User's question
            context (str, optional): Additional context about stocks/portfolio
            
        Returns:
            str: AI response
        """
        try:
            # Build full prompt with context
            if context:
                full_prompt = f"{self.system_prompt}\n\nTh√¥ng tin v·ªÅ c·ªï phi·∫øu ƒëang ph√¢n t√≠ch:\n{context}\n\nC√¢u h·ªèi: {user_message}"
            else:
                full_prompt = f"{self.system_prompt}\n\nC√¢u h·ªèi: {user_message}"
            
            # Generate response
            response = self.model.generate_content(full_prompt)
            
            # Store in history
            self.chat_history.append({
                "user": user_message,
                "assistant": response.text
            })
            
            return response.text
            
        except Exception as e:
            return f"‚ö†Ô∏è Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra: {str(e)}"
    
    def get_portfolio_context(self, selected_stocks: Optional[List[str]] = None, 
                            optimization_result: Optional[Dict] = None) -> str:
        """
        Build context string from portfolio data
        
        Args:
            selected_stocks (list): List of selected stock tickers
            optimization_result (dict): Portfolio optimization results
            
        Returns:
            str: Formatted context string
        """
        context_parts = []
        
        if selected_stocks:
            context_parts.append(f"C·ªï phi·∫øu ƒëang ph√¢n t√≠ch: {', '.join(selected_stocks)}")
        
        if optimization_result:
            context_parts.append(f"K·∫øt qu·∫£ t·ªëi ∆∞u h√≥a: {optimization_result}")
        
        return "\n".join(context_parts) if context_parts else None
    
    def clear_history(self):
        """Clear chat history"""
        self.chat_history = []


def create_quick_question_buttons() -> List[str]:
    """
    Create list of quick question suggestions
    
    Returns:
        List[str]: List of suggested questions
    """
    return [
        "Sentiment score l√† g√¨ v√† n√≥ ƒë∆∞·ª£c t√≠nh nh∆∞ th·∫ø n√†o?",
        "Ph√¢n t√≠ch c·∫£m x√∫c tin t·ª©c ·∫£nh h∆∞·ªüng ƒë·∫øn gi√° c·ªï phi·∫øu ra sao?",
        "Gi·∫£i th√≠ch v·ªÅ ki·ªÉm ƒë·ªãnh Granger causality?",
        "M√¥ h√¨nh TVAR ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?",
        "Correlation gi·ªØa sentiment v√† gi√° c√≥ √Ω nghƒ©a g√¨?",
        "L√†m sao ƒë·ªÉ ƒë√°nh gi√° ·∫£nh h∆∞·ªüng c·ªßa tin t·ª©c l√™n c·ªï phi·∫øu?",
        "PhoBERT ƒë∆∞·ª£c s·ª≠ d·ª•ng ra sao trong ph√¢n t√≠ch sentiment?",
        "Scandal ·∫£nh h∆∞·ªüng ƒë·∫øn gi√° c·ªï phi·∫øu nh∆∞ th·∫ø n√†o?"
    ]


# Backward compatibility - n·∫øu file n√†y ƒë∆∞·ª£c import nh·∫ßm nh∆∞ UI
def get_welcome_message():
    """Tr·∫£ v·ªÅ tin nh·∫Øn ch√†o m·ª´ng"""
    return """Xin ch√†o! üëã

T√¥i l√† tr·ª£ l√Ω AI c·ªßa Portfolio Dashboard. T√¥i c√≥ th·ªÉ gi√∫p b·∫°n:
- üìä Gi·∫£i th√≠ch c√°c ch·ªâ s·ªë t√†i ch√≠nh (Sharpe Ratio, volatility, return...)
- üíº T∆∞ v·∫•n v·ªÅ chi·∫øn l∆∞·ª£c ƒë·∫ßu t∆∞ v√† ph√¢n b·ªï danh m·ª•c
- ‚ö†Ô∏è Ph√¢n t√≠ch r·ªßi ro v√† l·ª£i nhu·∫≠n
- üéØ Gi·∫£i ƒë√°p c√°c c√¢u h·ªèi v·ªÅ t·ªëi ∆∞u h√≥a danh m·ª•c

H√£y ch·ªçn c√¢u h·ªèi g·ª£i √Ω b√™n d∆∞·ªõi ho·∫∑c ƒë·∫∑t c√¢u h·ªèi c·ªßa b·∫°n!"""

def _clear_chat_history():
    """X√≥a ho√†n to√†n l·ªãch s·ª≠ chat hi·ªán t·∫°i."""
    st.session_state.chat_messages = []
    chatbot_instance = st.session_state.get("chatbot")
    if chatbot_instance is not None:
        chatbot_instance.clear_history()
    st.session_state.show_quick_questions = True
    st.session_state.is_thinking = False

def reset_chat_with_welcome():
    """Reset chat history v√† th√™m l·∫°i welcome message"""
    _clear_chat_history()
    st.session_state.chat_messages.append({
        "role": "assistant",
        "content": get_welcome_message()
    })

def initialize_chatbot_session():
    """Kh·ªüi t·∫°o session state cho chatbot"""
    if 'chatbot' not in st.session_state:
        try:
            from config.settings import GEMINI_API_KEY
            
            # Ki·ªÉm tra API key c√≥ h·ª£p l·ªá kh√¥ng
            if not GEMINI_API_KEY or GEMINI_API_KEY == "your-gemini-api-key-here":
                st.session_state.chatbot = None
                st.session_state.chatbot_error = "Ch∆∞a c·∫•u h√¨nh GEMINI_API_KEY trong config.py"
            else:
                st.session_state.chatbot = PortfolioChatbot(GEMINI_API_KEY)
                
        except (ImportError, AttributeError) as e:
            st.session_state.chatbot = None
            st.session_state.chatbot_error = f"L·ªói import: {str(e)}"
        except Exception as e:
            st.session_state.chatbot = None
            st.session_state.chatbot_error = f"L·ªói kh·ªüi t·∫°o chatbot: {str(e)}"
    
    if 'chat_messages' not in st.session_state:
        st.session_state.chat_messages = []
        # Th√™m tin nh·∫Øn ch√†o m·ªü ƒë·∫ßu t·ª´ chatbot
        if st.session_state.chatbot is not None:
            st.session_state.chat_messages.append({
                "role": "assistant",
                "content": get_welcome_message()
            })
    
    if 'show_quick_questions' not in st.session_state:
        st.session_state.show_quick_questions = True
    
    if 'is_thinking' not in st.session_state:
        st.session_state.is_thinking = False


def render_chat_controls(container, key_prefix="sidebar"):
    """Hi·ªÉn th·ªã c√°c n√∫t thao t√°c chatbot trong container ƒë∆∞·ª£c cung c·∫•p."""
    is_thinking = st.session_state.get('is_thinking', False)
    col1, col2 = container.columns(2)
    if col1.button(
        "X√≥a l·ªãch s·ª≠",
        key=f"{key_prefix}_clear_btn",
        use_container_width=True,
        disabled=is_thinking
    ):
        _clear_chat_history()
        st.rerun()

    if col2.button(
        "Cu·ªôc tr√≤ chuy·ªán m·ªõi",
        key=f"{key_prefix}_new_btn",
        use_container_width=True,
        disabled=is_thinking
    ):
        reset_chat_with_welcome()
        st.rerun()


def render_chatbot_sidebar(portfolio_context=None):
    """
    Render giao di·ªán chatbot trong sidebar
    
    Args:
        portfolio_context (dict): Context v·ªÅ danh m·ª•c ƒë·∫ßu t∆∞ hi·ªán t·∫°i
    """
    # Kh·ªüi t·∫°o chatbot session
    initialize_chatbot_session()
    
    # Ki·ªÉm tra l·ªói c·∫•u h√¨nh - hi·ªÉn th·ªã tr∆∞·ªõc expander
    if st.session_state.chatbot is None:
        with st.sidebar:
            st.warning(st.session_state.get('chatbot_error', 'L·ªói kh·ªüi t·∫°o chatbot'))
            st.info("Vui l√≤ng th√™m `GEMINI_API_KEY = 'your-api-key'` v√†o file scripts/config.py\n\nL·∫•y API key mi·ªÖn ph√≠ t·∫°i: https://makersuite.google.com/app/apikey")
        return
    
    # T·∫°o expander cho chatbot v·ªõi c√°c n√∫t h√†nh ƒë·ªông b√™n trong
    chat_section = st.sidebar.expander("Tr·ª£ l√Ω AI", expanded=False)

    with chat_section:
        st.markdown("ƒê·∫∑t c√¢u h·ªèi v·ªÅ ƒë·∫ßu t∆∞, chi·∫øn l∆∞·ª£c, ho·∫∑c c√°c ch·ªâ s·ªë t√†i ch√≠nh")
        
        # C√°c n√∫t h√†nh ƒë·ªông ·ªü ƒë·∫ßu expander
        render_chat_controls(chat_section, key_prefix="sidebar")
        
        st.markdown("---")
        
        # Container v·ªõi chi·ªÅu cao c·ªë ƒë·ªãnh v√† thanh cu·ªôn
        chat_container = st.container(height=400)
        with chat_container:
            # Hi·ªÉn th·ªã l·ªãch s·ª≠ chat
            for message in st.session_state.chat_messages:
                with st.chat_message(message["role"]):
                    st.markdown(message["content"])
            
            # Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang suy nghƒ© v·ªõi animation
            if st.session_state.is_thinking:
                with st.chat_message("assistant"):
                    st.markdown("_ƒêang suy nghƒ©..._")
            
            # Hi·ªÉn th·ªã c√°c c√¢u h·ªèi g·ª£i √Ω n·∫øu c√≥ √≠t h∆°n 2 tin nh·∫Øn (ch·ªâ c√≥ welcome message)
            if len(st.session_state.chat_messages) <= 1 and st.session_state.show_quick_questions and not st.session_state.is_thinking:
                st.markdown("---")
                st.markdown("**C√¢u h·ªèi g·ª£i √Ω:**")
                quick_questions = create_quick_question_buttons()
                
                for i, question in enumerate(quick_questions):
                    if st.button(question, key=f"quick_q_{i}", use_container_width=True, disabled=st.session_state.is_thinking, type="secondary"):
                        handle_user_message(question, portfolio_context, chat_parent=chat_container)
                        st.session_state.show_quick_questions = False
                        st.rerun()
        
        # Input chat
        user_input = st.chat_input("Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...", disabled=st.session_state.is_thinking)
        
        if user_input and not st.session_state.is_thinking:
            handle_user_message(user_input, portfolio_context, chat_parent=chat_container)
            st.session_state.show_quick_questions = False
            st.rerun()



def handle_user_message(user_message, portfolio_context=None, chat_parent=None):
    """
    X·ª≠ l√Ω tin nh·∫Øn t·ª´ ng∆∞·ªùi d√πng
    
    Args:
        user_message (str): Tin nh·∫Øn t·ª´ ng∆∞·ªùi d√πng
        portfolio_context (dict): Context v·ªÅ danh m·ª•c
    """
    # Th√™m tin nh·∫Øn user v√†o chat
    st.session_state.chat_messages.append({
        "role": "user",
        "content": user_message
    })

    # ƒê√°nh d·∫•u ƒëang x·ª≠ l√Ω ƒë·ªÉ disable input v√† hi·ªÉn th·ªã ti·∫øn tr√¨nh
    st.session_state.is_thinking = True

    # X√°c ƒë·ªãnh container hi·ªÉn th·ªã chat hi·ªán t·∫°i
    chat_context = chat_parent if chat_parent is not None else st

    # Hi·ªÉn th·ªã l·∫°i tin nh·∫Øn ng∆∞·ªùi d√πng ngay l·∫≠p t·ª©c trong khung chat hi·ªán t·∫°i
    with chat_context.chat_message("user"):
        st.markdown(user_message)

    try:
        # L·∫•y context text n·∫øu c√≥
        context_text = None
        if portfolio_context:
            context_text = st.session_state.chatbot.get_portfolio_context(
                selected_stocks=portfolio_context.get('selected_stocks'),
                optimization_result=portfolio_context.get('optimization_result')
            )

        # Hi·ªÉn th·ªã spinner "ƒëang suy nghƒ©" trong khung chat c·ªßa bot
        with chat_context.chat_message("assistant"):
            with st.spinner("Tr·ª£ l√Ω ƒëang suy nghƒ©..."):
                response = st.session_state.chatbot.generate_response(
                    user_message,
                    context_text
                )
            st.markdown(response)

        # L∆∞u response v√†o l·ªãch s·ª≠ chat ƒë·ªÉ hi·ªÉn th·ªã ·ªü l∆∞·ª£t rerun ti·∫øp theo
        st.session_state.chat_messages.append({
            "role": "assistant",
            "content": response
        })
    except Exception as e:
        error_message = f"Xin l·ªói, ƒë√£ c√≥ l·ªói x·∫£y ra: {str(e)}"
        with chat_context.chat_message("assistant"):
            st.error(error_message)
        st.session_state.chat_messages.append({
            "role": "assistant",
            "content": error_message
        })
    finally:
        st.session_state.is_thinking = False


def get_current_portfolio_context():
    """
    L·∫•y context v·ªÅ danh m·ª•c ƒë·∫ßu t∆∞ hi·ªán t·∫°i t·ª´ session state
    
    Returns:
        dict: Context v·ªÅ danh m·ª•c
    """
    context = {}
    
    # L·∫•y danh s√°ch c·ªï phi·∫øu ƒë√£ ch·ªçn
    if 'manual_selected_stocks' in st.session_state and st.session_state.manual_selected_stocks:
        context['selected_stocks'] = st.session_state.manual_selected_stocks
    elif 'auto_selected_stocks' in st.session_state and st.session_state.auto_selected_stocks:
        context['selected_stocks'] = st.session_state.auto_selected_stocks
    
    # C√≥ th·ªÉ th√™m optimization result n·∫øu c√≥ trong session
    # context['optimization_result'] = st.session_state.get('last_optimization_result')
    
    return context if context else None


def render_chatbot_page():
    """
    Render trang chatbot ƒë·∫ßy ƒë·ªß (kh√¥ng ph·∫£i sidebar)
    """
    # Kh·ªüi t·∫°o chatbot session
    initialize_chatbot_session()
    
    # CSS cho giao di·ªán chatbot
    st.markdown("""
        <style>
        /* Animation cho thinking dots */
        @keyframes blink {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }
        
        /* Styling cho tin nh·∫Øn ng∆∞·ªùi d√πng */
        [data-testid="stChatMessage"][data-testid*="user"] {
            background-color: #E3F2FD;
            border-radius: 18px;
            padding: 12px 16px;
            margin-left: 20%;
            margin-bottom: 12px;
        }
        
        /* Styling cho tin nh·∫Øn bot */
        [data-testid="stChatMessage"][data-testid*="assistant"] {
            background-color: #F5F5F5;
            border-radius: 18px;
            padding: 12px 16px;
            margin-right: 20%;
            margin-bottom: 12px;
        }
        
        /* Thinking indicator */
        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 10px 15px;
            background-color: #F5F5F5;
            border-radius: 15px;
            margin-left: 10px;
        }
        
        .thinking-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #666;
            animation: blink 1.4s infinite;
        }
        
        .thinking-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .thinking-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        /* Input bar styling v·ªõi focus effect */
        .stChatInputContainer {
            border: 2px solid #E0E0E0;
            border-radius: 25px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .stChatInputContainer:focus-within {
            border-color: #2196F3;
            box-shadow: 0 4px 12px rgba(33,150,243,0.2);
            transform: translateY(-1px);
        }
        
        /* Styling cho c√°c n√∫t g·ª£i √Ω */
        .stButton > button[kind="secondary"] {
            border-radius: 20px;
            border: 1px solid #E0E0E0;
            background: white;
            padding: 10px 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stButton > button[kind="secondary"]:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102,126,234,0.3);
        }
        </style>
    """, unsafe_allow_html=True)
    
    # Header v·ªõi title v√† c√°c n√∫t h√†nh ƒë·ªông
    col_title = st.columns([1])[0]
    with col_title:
        st.title("Tr·ª£ l√Ω AI - T∆∞ v·∫•n ƒë·∫ßu t∆∞")
        st.markdown("ƒê·∫∑t c√¢u h·ªèi v·ªÅ ƒë·∫ßu t∆∞, chi·∫øn l∆∞·ª£c, ho·∫∑c c√°c ch·ªâ s·ªë t√†i ch√≠nh")
    
    st.markdown("---")
    
    # Ki·ªÉm tra l·ªói c·∫•u h√¨nh
    if st.session_state.chatbot is None:
        st.error(st.session_state.get('chatbot_error', 'L·ªói kh·ªüi t·∫°o chatbot'))
        st.info("Vui l√≤ng th√™m GEMINI_API_KEY v√†o file scripts/config.py. L·∫•y API key mi·ªÖn ph√≠ t·∫°i: https://makersuite.google.com/app/apikey")
        return
    
    # Container cho chat v·ªõi chi·ªÅu cao l·ªõn h∆°n
    chat_container = st.container(height=500)
    with chat_container:
        # Hi·ªÉn th·ªã l·ªãch s·ª≠ chat
        for idx, message in enumerate(st.session_state.chat_messages):
            with st.chat_message(message["role"]):
                st.markdown(message["content"])
        
        # Hi·ªÉn th·ªã tr·∫°ng th√°i ƒëang suy nghƒ© v·ªõi animation
        if st.session_state.is_thinking:
            with st.chat_message("assistant"):
                st.markdown("""
                <div class="thinking-indicator">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
                """, unsafe_allow_html=True)
        
        # Hi·ªÉn th·ªã c√°c c√¢u h·ªèi g·ª£i √Ω d∆∞·ªõi d·∫°ng chips c√≥ th·ªÉ click
        if len(st.session_state.chat_messages) <= 1 and st.session_state.show_quick_questions and not st.session_state.is_thinking:
            st.markdown("---")
            st.markdown("**üí° C√¢u h·ªèi g·ª£i √Ω - Nh·∫•p ƒë·ªÉ b·∫Øt ƒë·∫ßu:**")
            
            quick_questions = create_quick_question_buttons()
            
            # T·∫°o layout grid cho c√°c chips
            cols = st.columns(2)
            for i, question in enumerate(quick_questions):
                col_idx = i % 2
                with cols[col_idx]:
                    if st.button(question, key=f"page_quick_q_{i}", use_container_width=True, disabled=st.session_state.is_thinking, type="secondary"):
                        portfolio_context = get_current_portfolio_context()
                        handle_user_message(question, portfolio_context, chat_parent=chat_container)
                        st.session_state.show_quick_questions = False
                        st.rerun()
    
    # Input chat ·ªü ngo√†i container ƒë·ªÉ kh√¥ng b·ªã cu·ªôn
    user_input = st.chat_input("Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n...", disabled=st.session_state.is_thinking)
    
    if user_input and not st.session_state.is_thinking:
        portfolio_context = get_current_portfolio_context()
        handle_user_message(user_input, portfolio_context, chat_parent=chat_container)
        st.session_state.show_quick_questions = False
        st.rerun()
